<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Preview Students</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table-responsive { overflow-x: auto; }
        .error { color: red; font-size: 0.9em; }
        .changed-field { background-color: #fff3cd !important; }
        .old-value { font-size: 0.85em; color: #6c757d; margin-top: 2px; }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2>Preview & Edit (<span th:text="${validCount}"></span> valid of <span th:text="${totalImported}"></span>)</h2>
    <div class="alert alert-info" id="changesAlert" style="display:none;">
        <i class="fas fa-info-circle"></i> <strong>Changes Detected:</strong> Yellow highlighted fields have changed values.
        <button type="button" class="btn btn-sm btn-primary ms-3" onclick="keepAllChanges()">
            <i class="fas fa-check-double"></i> Keep All New Values
        </button>
        <button type="button" class="btn btn-sm btn-secondary ms-2" onclick="revertAllChanges()">
            <i class="fas fa-undo"></i> Revert All Changes
        </button>
    </div>
    <form th:action="@{/upload/confirm}" method="post">
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead class="table-light">
                <tr>
                    <th>Student ID</th><th>Full Name</th><th>DOB</th><th>Gender</th><th>APAAR ID</th><th>Aadhaar</th><th>Category</th><th>Address</th>
                    <th>Photo</th><th>TC</th><th>Adm Class</th><th>Adm Date</th><th>Enroll No</th><th>Marksheet</th>
                    <th>Blood</th><th>Allergies</th><th>Immunized</th><th>Height</th><th>Weight</th><th>Vision</th>
                    <th>Char Cert</th><th>Fee</th><th>Attend %</th><th>UDISE</th>
                    <th>Father</th><th>F. Contact</th><th>F. Aadhaar</th>
                    <th>Mother</th><th>M. Contact</th><th>M. Aadhaar</th>
                    <th>Guardian</th><th>G. Contact</th><th>G. Relation</th><th>G. Aadhaar</th>
                    <th>Family</th><th>Lang</th>
                    <th>Status</th><th>Errors</th><th>Remove</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="s, iter : ${students}" th:class="${!s.valid} ? 'table-danger' : ''" th:attr="data-has-changes=${!s.changedFields.isEmpty()}">
                    <td th:class="${s.changedFields['studentId']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].studentId|" th:value="${s.studentId}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['studentId']}" class="old-value">
                            Old: <span th:text="${s.oldValues['studentId']}"></span>
                            <input type="hidden" th:name="|students[${iter.index}].old_studentId|" th:value="${s.oldValues['studentId']}"/>
                        </div>
                    </td>
                    <td th:class="${s.changedFields['fullName']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].fullName|" th:value="${s.fullName}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['fullName']}" class="old-value">
                            Old: <span th:text="${s.oldValues['fullName']}"></span>
                            <input type="hidden" th:name="|students[${iter.index}].old_fullName|" th:value="${s.oldValues['fullName']}"/>
                        </div>
                    </td>
                    <td th:class="${s.changedFields['dateOfBirth']} ? 'changed-field' : ''">
                        <input type="date" th:name="|students[${iter.index}].dateOfBirth|" th:value="${s.dateOfBirth}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['dateOfBirth']}" class="old-value">
                            Old: <span th:text="${s.oldValues['dateOfBirth']}"></span>
                        </div>
                    </td>
                    <td><input th:name="|students[${iter.index}].gender|" th:value="${s.gender}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].apaarId|" th:value="${s.apaarId}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].aadhaarNumber|" th:value="${s.aadhaarNumber}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].category|" th:value="${s.category}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].address|" th:value="${s.address}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].photoUrl|" th:value="${s.photoUrl}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].previousSchoolTcUrl|" th:value="${s.previousSchoolTcUrl}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].admissionClass|" th:value="${s.admissionClass}" class="form-control form-control-sm"/></td>
                    <td><input type="date" th:name="|students[${iter.index}].admissionDate|" th:value="${s.admissionDate}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].enrollmentNo|" th:value="${s.enrollmentNo}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].previousMarksheetUrl|" th:value="${s.previousMarksheetUrl}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].bloodGroup|" th:value="${s.bloodGroup}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].allergiesConditions|" th:value="${s.allergiesConditions}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].immunization|" th:value="${s.immunization}" class="form-control form-control-sm"/></td>
                    <td><input type="number" th:name="|students[${iter.index}].heightCm|" th:value="${s.heightCm}" class="form-control form-control-sm"/></td>
                    <td><input type="number" th:name="|students[${iter.index}].weightKg|" th:value="${s.weightKg}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].visionCheck|" th:value="${s.visionCheck}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].characterCertUrl|" th:value="${s.characterCertUrl}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].feeStatus|" th:value="${s.feeStatus}" class="form-control form-control-sm"/></td>
                    <td><input type="number" step="0.01" th:name="|students[${iter.index}].attendancePercent|" th:value="${s.attendancePercent}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].udiseUploaded|" th:value="${s.udiseUploaded}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].fatherName|" th:value="${s.fatherName}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].fatherContact|" th:value="${s.fatherContact}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].fatherAadhaar|" th:value="${s.fatherAadhaar}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].motherName|" th:value="${s.motherName}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].motherContact|" th:value="${s.motherContact}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].motherAadhaar|" th:value="${s.motherAadhaar}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].guardianName|" th:value="${s.guardianName}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].guardianContact|" th:value="${s.guardianContact}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].guardianRelation|" th:value="${s.guardianRelation}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].guardianAadhaar|" th:value="${s.guardianAadhaar}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].familyStatus|" th:value="${s.familyStatus}" class="form-control form-control-sm"/></td>
                    <td><input th:name="|students[${iter.index}].languagePreference|" th:value="${s.languagePreference}" class="form-control form-control-sm"/></td>
                    <td><span th:text="${s.valid} ? 'Valid' : 'Invalid'" class="badge" th:class="${s.valid} ? 'bg-success' : 'bg-danger'"></span></td>
                    <td><div th:each="e : ${s.errors}" class="error" th:text="${e}"></div></td>
                    <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">X</button></td>
                </tr>
                </tbody>
            </table>
        </div>
        <button type="submit" class="btn btn-success btn-lg">Confirm & Save</button>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Show changes alert if any row has changes
    document.addEventListener('DOMContentLoaded', function() {
        const rowsWithChanges = document.querySelectorAll('tr[data-has-changes="true"]');
        if (rowsWithChanges.length > 0) {
            document.getElementById('changesAlert').style.display = 'block';
        }
    });

    // Keep all new values - set all changed fields to new values (already the case, just visual feedback)
    function keepAllChanges() {
        const changedFields = document.querySelectorAll('.changed-field input');
        alert('All new values will be saved. Review and click "Confirm & Save" when ready.');
    }

    // Revert all changes - set all changed fields back to old values
    function revertAllChanges() {
        const changedCells = document.querySelectorAll('td.changed-field');
        changedCells.forEach(cell => {
            const input = cell.querySelector('input:not([type="hidden"])');
            const oldValueInput = cell.querySelector('input[type="hidden"]');
            if (input && oldValueInput) {
                input.value = oldValueInput.value;
            }
        });
        alert('All changes reverted to original values. Review and click "Confirm & Save" when ready.');
    }
</script>
</body>
</html>