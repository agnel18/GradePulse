<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Preview Students</title>
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: rgba(0,0,0,0.08);
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --border-color: rgba(255,255,255,0.1);
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .container {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-radius: 10px;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        
        .table {
            color: var(--text-primary);
            background-color: var(--bg-secondary);
        }
        
        .table tbody td {
            background-color: var(--bg-secondary);
        }
        
        .table-bordered {
            border-color: var(--border-color);
        }
        
        .table-bordered th,
        .table-bordered td {
            border-color: var(--border-color);
            background-color: var(--bg-secondary);
        }
        
        .table-light {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .table-light th {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        [data-theme="dark"] input.form-control {
            background-color: #374151;
            color: var(--text-primary);
        }
        
        .table-responsive { 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
        }
        .table td, .table th {
            min-width: 120px;
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 8px 12px;
        }
        .table td:nth-last-child(2) {
            /* Error column - allow wrapping and wider width */
            white-space: normal;
            max-width: 350px;
            min-width: 200px;
        }
        .table td input.form-control {
            min-width: 110px;
        }
        .error { color: red; font-size: 0.9em; }
        .changed-field { background-color: #fff3cd !important; }
        [data-theme="dark"] .changed-field { background-color: #ffc107 !important; color: #000 !important; }
        .old-value { font-size: 0.85em; color: #6c757d; margin-top: 2px; }
        [data-theme="dark"] .old-value { color: var(--text-secondary); }
        @media (max-width: 768px) {
            .table td, .table th { min-width: 100px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Preview & Edit (<span th:text="${validCount}"></span> valid of <span th:text="${totalImported}"></span>)</h2>
        <span class="theme-toggle" onclick="toggleTheme()" style="cursor: pointer; font-size: 1.5rem; padding: 0.5rem; border-radius: 8px; transition: all 0.3s; color: var(--text-primary);" onmouseover="this.style.backgroundColor='var(--bg-primary)'" onmouseout="this.style.backgroundColor='transparent'" title="Toggle Dark Mode">
            <i class="fas fa-moon" id="themeIcon"></i>
        </span>
    </div>
    <div class="alert alert-info" id="changesAlert" style="display:none;">
        <i class="fas fa-info-circle"></i> <strong>Changes Detected:</strong> Yellow highlighted fields have changed values.
        <button type="button" class="btn btn-sm btn-primary ms-3" onclick="keepAllChanges()">
            <i class="fas fa-check-double"></i> Keep All New Values
        </button>
        <button type="button" class="btn btn-sm btn-secondary ms-2" onclick="revertAllChanges()">
            <i class="fas fa-undo"></i> Revert All Changes
        </button>
    </div>
    <form th:action="@{/upload/confirm}" method="post">
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead class="table-light">
                <tr>
                    <!-- V14 Priority Order: P0 Critical -->
                    <th th:if="${activeFieldNames.contains('student_id')}">Student ID <span class="badge bg-danger">⭐ Required</span></th>
                    <th th:if="${activeFieldNames.contains('full_name')}">Full Name <span class="badge bg-danger">⭐ Required</span></th>
                    <th th:if="${activeFieldNames.contains('school_name')}">School Name</th>
                    <th th:if="${activeFieldNames.contains('board')}">Board</th>
                    <th th:if="${activeFieldNames.contains('academic_year')}">Current Academic Year</th>
                    <th th:if="${activeFieldNames.contains('student_class')}">Class</th>
                    <th th:if="${activeFieldNames.contains('division')}">Division/Stream</th>
                    <th th:if="${activeFieldNames.contains('sub_division')}">Sub-Division/Section</th>
                    <th th:if="${activeFieldNames.contains('gender')}">Gender <span class="badge bg-danger">⭐ Required</span></th>
                    <th th:if="${activeFieldNames.contains('father_name')}">Father Name</th>
                    <th th:if="${activeFieldNames.contains('father_contact')}">F. Contact <span class="badge bg-danger">⭐ Required</span></th>
                    <th th:if="${activeFieldNames.contains('mother_name')}">Mother Name</th>
                    <th th:if="${activeFieldNames.contains('mother_contact')}">M. Contact <span class="badge bg-danger">⭐ Required</span></th>
                    
                    <!-- P1 High Priority -->
                    <th th:if="${activeFieldNames.contains('date_of_birth')}">DOB</th>
                    <th th:if="${activeFieldNames.contains('category')}">Category</th>
                    <th th:if="${activeFieldNames.contains('address')}">Address</th>
                    <th th:if="${activeFieldNames.contains('apaar_id')}">APAAR ID</th>
                    <th th:if="${activeFieldNames.contains('admission_class')}">Adm Class</th>
                    <th th:if="${activeFieldNames.contains('admission_date')}">Adm Date</th>
                    <th th:if="${activeFieldNames.contains('enrollment_no')}">Enroll No</th>
                    <th th:if="${activeFieldNames.contains('guardian_name')}">Guardian</th>
                    <th th:if="${activeFieldNames.contains('guardian_contact')}">G. Contact</th>
                    <th th:if="${activeFieldNames.contains('guardian_relation')}">G. Relation</th>
                    <th th:if="${activeFieldNames.contains('family_status')}">Family</th>
                    <th th:if="${activeFieldNames.contains('language_preference')}">Lang</th>
                    
                    <!-- P2 Medium Priority -->
                    <th th:if="${activeFieldNames.contains('aadhaar_number')}">Student Aadhaar</th>
                    <th th:if="${activeFieldNames.contains('father_aadhaar')}">F. Aadhaar</th>
                    <th th:if="${activeFieldNames.contains('mother_aadhaar')}">M. Aadhaar</th>
                    <th th:if="${activeFieldNames.contains('guardian_aadhaar')}">G. Aadhaar</th>
                    <th th:if="${activeFieldNames.contains('previous_school_tc_url')}">TC</th>
                    <th th:if="${activeFieldNames.contains('previous_marksheet_url')}">Marksheet</th>
                    <th th:if="${activeFieldNames.contains('character_cert_url')}">Char Cert</th>
                    <th th:if="${activeFieldNames.contains('photo_url')}">Photo</th>
                    <th th:if="${activeFieldNames.contains('blood_group')}">Blood</th>
                    
                    <!-- P3 Low Priority -->
                    <th th:if="${activeFieldNames.contains('fee_status')}">Fee</th>
                    <th th:if="${activeFieldNames.contains('attendance_percent')}">Attend %</th>
                    <th th:if="${activeFieldNames.contains('udise_uploaded')}">UDISE</th>
                    
                    <th>Status</th><th>Errors</th><th>Remove</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="s, iter : ${students}" th:class="${!s.valid} ? 'table-danger' : ''" th:attr="data-has-changes=${!s.changedFields.isEmpty()}">
                    <!-- V14 Priority Order: P0 Critical -->
                    <td th:if="${activeFieldNames.contains('student_id')}" th:class="${s.changedFields['studentId']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].studentId|" th:value="${s.studentId}" class="form-control form-control-sm" required/>
                        <div th:if="${s.changedFields['studentId']}" class="old-value">Old: <span th:text="${s.oldValues['studentId']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('full_name')}" th:class="${s.changedFields['fullName']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].fullName|" th:value="${s.fullName}" class="form-control form-control-sm" required/>
                        <div th:if="${s.changedFields['fullName']}" class="old-value">Old: <span th:text="${s.oldValues['fullName']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('school_name')}" th:class="${s.changedFields['schoolName']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].schoolName|" th:value="${s.schoolName}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['schoolName']}" class="old-value">Old: <span th:text="${s.oldValues['schoolName']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('board')}" th:class="${s.changedFields['board']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].board|" th:value="${s.board}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['board']}" class="old-value">Old: <span th:text="${s.oldValues['board']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('academic_year')}" th:class="${s.changedFields['academicYear']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].academicYear|" th:value="${s.academicYear}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['academicYear']}" class="old-value">Old: <span th:text="${s.oldValues['academicYear']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('student_class')}" th:class="${s.changedFields['studentClass']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].studentClass|" th:value="${s.studentClass}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['studentClass']}" class="old-value">Old: <span th:text="${s.oldValues['studentClass']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('division')}" th:class="${s.changedFields['division']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].division|" th:value="${s.division}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['division']}" class="old-value">Old: <span th:text="${s.oldValues['division']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('sub_division')}" th:class="${s.changedFields['subDivision']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].subDivision|" th:value="${s.subDivision}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['subDivision']}" class="old-value">Old: <span th:text="${s.oldValues['subDivision']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('gender')}" th:class="${s.changedFields['gender']} ? 'changed-field' : ''">
                        <select th:name="|students[${iter.index}].gender|" class="form-control form-control-sm" required>
                            <option value="">Select</option>
                            <option th:value="'Male'" th:selected="${s.gender == 'Male'}">Male</option>
                            <option th:value="'Female'" th:selected="${s.gender == 'Female'}">Female</option>
                            <option th:value="'Other'" th:selected="${s.gender == 'Other'}">Other</option>
                        </select>
                        <div th:if="${s.changedFields['gender']}" class="old-value">Old: <span th:text="${s.oldValues['gender']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('father_name')}" th:class="${s.changedFields['fatherName']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].fatherName|" th:value="${s.fatherName}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['fatherName']}" class="old-value">Old: <span th:text="${s.oldValues['fatherName']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('father_contact')}" th:class="${s.changedFields['fatherContact']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].fatherContact|" th:value="${s.fatherContact}" class="form-control form-control-sm" required/>
                        <div th:if="${s.changedFields['fatherContact']}" class="old-value">Old: <span th:text="${s.oldValues['fatherContact']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('mother_name')}" th:class="${s.changedFields['motherName']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].motherName|" th:value="${s.motherName}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['motherName']}" class="old-value">Old: <span th:text="${s.oldValues['motherName']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('mother_contact')}" th:class="${s.changedFields['motherContact']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].motherContact|" th:value="${s.motherContact}" class="form-control form-control-sm" required/>
                        <div th:if="${s.changedFields['motherContact']}" class="old-value">Old: <span th:text="${s.oldValues['motherContact']}"></span></div>
                    </td>
                    
                    <!-- P1 High Priority -->
                    <td th:if="${activeFieldNames.contains('date_of_birth')}" th:class="${s.changedFields['dateOfBirth']} ? 'changed-field' : ''">
                        <input type="date" th:name="|students[${iter.index}].dateOfBirth|" th:value="${s.dateOfBirth}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['dateOfBirth']}" class="old-value">Old: <span th:text="${s.oldValues['dateOfBirth']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('category')}" th:class="${s.changedFields['category']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].category|" th:value="${s.category}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['category']}" class="old-value">Old: <span th:text="${s.oldValues['category']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('address')}" th:class="${s.changedFields['address']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].address|" th:value="${s.address}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['address']}" class="old-value">Old: <span th:text="${s.oldValues['address']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('apaar_id')}" th:class="${s.changedFields['apaarId']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].apaarId|" th:value="${s.apaarId}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['apaarId']}" class="old-value">Old: <span th:text="${s.oldValues['apaarId']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('admission_class')}" th:class="${s.changedFields['admissionClass']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].admissionClass|" th:value="${s.admissionClass}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['admissionClass']}" class="old-value">Old: <span th:text="${s.oldValues['admissionClass']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('admission_date')}" th:class="${s.changedFields['admissionDate']} ? 'changed-field' : ''">
                        <input type="date" th:name="|students[${iter.index}].admissionDate|" th:value="${s.admissionDate}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['admissionDate']}" class="old-value">Old: <span th:text="${s.oldValues['admissionDate']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('enrollment_no')}" th:class="${s.changedFields['enrollmentNo']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].enrollmentNo|" th:value="${s.enrollmentNo}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['enrollmentNo']}" class="old-value">Old: <span th:text="${s.oldValues['enrollmentNo']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('guardian_name')}" th:class="${s.changedFields['guardianName']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].guardianName|" th:value="${s.guardianName}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['guardianName']}" class="old-value">Old: <span th:text="${s.oldValues['guardianName']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('guardian_contact')}" th:class="${s.changedFields['guardianContact']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].guardianContact|" th:value="${s.guardianContact}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['guardianContact']}" class="old-value">Old: <span th:text="${s.oldValues['guardianContact']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('guardian_relation')}" th:class="${s.changedFields['guardianRelation']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].guardianRelation|" th:value="${s.guardianRelation}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['guardianRelation']}" class="old-value">Old: <span th:text="${s.oldValues['guardianRelation']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('family_status')}" th:class="${s.changedFields['familyStatus']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].familyStatus|" th:value="${s.familyStatus}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['familyStatus']}" class="old-value">Old: <span th:text="${s.oldValues['familyStatus']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('language_preference')}" th:class="${s.changedFields['languagePreference']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].languagePreference|" th:value="${s.languagePreference}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['languagePreference']}" class="old-value">Old: <span th:text="${s.oldValues['languagePreference']}"></span></div>
                    </td>
                    
                    <!-- P2 Medium Priority -->
                    <td th:if="${activeFieldNames.contains('aadhaar_number')}" th:class="${s.changedFields['aadhaarNumber']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].aadhaarNumber|" th:value="${s.aadhaarNumber}" class="form-control form-control-sm" maxlength="12"/>
                        <div th:if="${s.changedFields['aadhaarNumber']}" class="old-value">Old: <span th:text="${s.oldValues['aadhaarNumber']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('father_aadhaar')}" th:class="${s.changedFields['fatherAadhaar']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].fatherAadhaar|" th:value="${s.fatherAadhaar}" class="form-control form-control-sm" maxlength="12"/>
                        <div th:if="${s.changedFields['fatherAadhaar']}" class="old-value">Old: <span th:text="${s.oldValues['fatherAadhaar']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('mother_aadhaar')}" th:class="${s.changedFields['motherAadhaar']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].motherAadhaar|" th:value="${s.motherAadhaar}" class="form-control form-control-sm" maxlength="12"/>
                        <div th:if="${s.changedFields['motherAadhaar']}" class="old-value">Old: <span th:text="${s.oldValues['motherAadhaar']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('guardian_aadhaar')}" th:class="${s.changedFields['guardianAadhaar']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].guardianAadhaar|" th:value="${s.guardianAadhaar}" class="form-control form-control-sm" maxlength="12"/>
                        <div th:if="${s.changedFields['guardianAadhaar']}" class="old-value">Old: <span th:text="${s.oldValues['guardianAadhaar']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('previous_school_tc_url')}" th:class="${s.changedFields['previousSchoolTcUrl']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].previousSchoolTcUrl|" th:value="${s.previousSchoolTcUrl}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['previousSchoolTcUrl']}" class="old-value">Old: <span th:text="${s.oldValues['previousSchoolTcUrl']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('previous_marksheet_url')}" th:class="${s.changedFields['previousMarksheetUrl']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].previousMarksheetUrl|" th:value="${s.previousMarksheetUrl}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['previousMarksheetUrl']}" class="old-value">Old: <span th:text="${s.oldValues['previousMarksheetUrl']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('character_cert_url')}" th:class="${s.changedFields['characterCertUrl']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].characterCertUrl|" th:value="${s.characterCertUrl}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['characterCertUrl']}" class="old-value">Old: <span th:text="${s.oldValues['characterCertUrl']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('photo_url')}" th:class="${s.changedFields['photoUrl']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].photoUrl|" th:value="${s.photoUrl}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['photoUrl']}" class="old-value">Old: <span th:text="${s.oldValues['photoUrl']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('blood_group')}" th:class="${s.changedFields['bloodGroup']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].bloodGroup|" th:value="${s.bloodGroup}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['bloodGroup']}" class="old-value">Old: <span th:text="${s.oldValues['bloodGroup']}"></span></div>
                    </td>
                    
                    <!-- P3 Low Priority -->
                    <td th:if="${activeFieldNames.contains('fee_status')}" th:class="${s.changedFields['feeStatus']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].feeStatus|" th:value="${s.feeStatus}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['feeStatus']}" class="old-value">Old: <span th:text="${s.oldValues['feeStatus']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('attendance_percent')}" th:class="${s.changedFields['attendancePercent']} ? 'changed-field' : ''">
                        <input type="number" step="0.01" th:name="|students[${iter.index}].attendancePercent|" th:value="${s.attendancePercent}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['attendancePercent']}" class="old-value">Old: <span th:text="${s.oldValues['attendancePercent']}"></span></div>
                    </td>
                    <td th:if="${activeFieldNames.contains('udise_uploaded')}" th:class="${s.changedFields['udiseUploaded']} ? 'changed-field' : ''">
                        <input th:name="|students[${iter.index}].udiseUploaded|" th:value="${s.udiseUploaded}" class="form-control form-control-sm"/>
                        <div th:if="${s.changedFields['udiseUploaded']}" class="old-value">Old: <span th:text="${s.oldValues['udiseUploaded']}"></span></div>
                    </td>
                    <!-- Status / Errors / Remove -->
                    <td><span th:text="${s.valid} ? 'Valid' : 'Invalid'" class="badge" th:class="${s.valid} ? 'bg-success' : 'bg-danger'"></span></td>
                    <td><div th:each="e : ${s.errors}" class="error" th:text="${e}"></div></td>
                    <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">X</button></td>
                </tr>
                </tbody>
            </table>
        </div>
        
        <div class="d-flex gap-3 mt-3">
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-check me-2"></i>Confirm & Save
            </button>
            <a href="/upload" class="btn btn-danger btn-lg">
                <i class="fas fa-times me-2"></i>Cancel
            </a>
        </div>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Show changes alert if any row has changes
    document.addEventListener('DOMContentLoaded', function() {
        const rowsWithChanges = document.querySelectorAll('tr[data-has-changes="true"]');
        if (rowsWithChanges.length > 0) {
            document.getElementById('changesAlert').style.display = 'block';
        }
    });

    // Keep all new values - set all changed fields to new values (already the case, just visual feedback)
    function keepAllChanges() {
        const changedFields = document.querySelectorAll('.changed-field input');
        alert('All new values will be saved. Review and click "Confirm & Save" when ready.');
    }

    // Revert all changes - set all changed fields back to old values
    function revertAllChanges() {
        const changedCells = document.querySelectorAll('td.changed-field');
        changedCells.forEach(cell => {
            const input = cell.querySelector('input:not([type="hidden"])');
            const oldValueInput = cell.querySelector('input[type="hidden"]');
            if (input && oldValueInput) {
                input.value = oldValueInput.value;
            }
        });
        alert('All changes reverted to original values. Review and click "Confirm & Save" when ready.');
    }

    // Theme Toggle Function
    function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        
        const icon = document.getElementById('themeIcon');
        if (newTheme === 'dark') {
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        } else {
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
        }
    }

    // Load saved theme on page load
    (function() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        const icon = document.getElementById('themeIcon');
        if (savedTheme === 'dark' && icon) {
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        }
    })();
</script>
<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/js/dashboard.js}"></script>
</body>
</html>