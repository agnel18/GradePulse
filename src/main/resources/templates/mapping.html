<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><title>Map Columns</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>.field-row{margin:8px 0;padding:8px;border:1px solid #ddd;border-radius:5px;}</style>
</head>
<body>
<div class="container mt-4">
    <h3>Map Excel Columns → System Fields</h3>
    <p><strong>File:</strong> <span th:text="${fileName}"></span></p>

    <form th:action="@{/upload/preview}" method="post">
        <input type="hidden" name="sessionId" th:value="${sessionId}"/>
        <div id="mappings"></div>

        <div class="mt-3">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCustom()">+ Add Custom Field</button>
            <button type="submit" class="btn btn-success">Preview Data</button>
        </div>
    </form>
</div>

<script>
const dbFields = /*[[${dbFields}]]*/ [];
const headers = /*ула[[${excelHeaders}]]*/;
let customIdx = 0;

function render() {
    const div = document.getElementById('mappings');
    div.innerHTML = '';
    headers.forEach((h, i) => {
        const row = document.createElement('div');
        row.className = 'field-row d-flex align-items-center';
        row.innerHTML = `
            <div class="flex-fill me-2"><strong>${h}</strong></div>
            <div class="flex-fill me-2">
                <select name="mapping[${i}].dbFieldId" class="form-control form-control-sm">
                    <option value="">-- Ignore --</option>
                    ${dbFields.map(f => `<option value="${f.id}">${f.displayName}</option>`).join('')}
                </select>
            </div>
            <div><span class="text-danger" style="cursor:pointer" onclick="this.parentElement.parentElement.remove()">X</span></div>
        `;
        div.appendChild(row);
    });
}
function addCustom() {
    const div = document.getElementById('mappings');
    const row = document.createElement('div');
    row.className = 'field-row bg-light d-flex align-items-center';
    customIdx++;
    row.innerHTML = `
        <input name="custom[${customIdx}].name" placeholder="Field Name" class="form-control form-control-sm me-2" required>
        <input name="custom[${customIdx}].display" placeholder="Display Name" class="form-control form-control-sm me-2" required>
        <select name="custom[${customIdx}].type" class="form-control form-control-sm me-2">
            <option>STRING</option><option>NUMBER</option><option>DATE</option><option>BOOLEAN</option>
        </select>
        <input type="checkbox" name="custom[${customIdx}].required"> Required
        <span class="text-danger" style="cursor:pointer" onclick="this.parentElement.remove()">X</span>
    `;
    div.appendChild(row);
}
render();
</script>
</body>
</html>